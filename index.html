<script>

let usuario = JSON.parse(localStorage.getItem("usuario"));
let carrinho = JSON.parse(localStorage.getItem("carrinho")) || [];
let comentarios = JSON.parse(localStorage.getItem("comentarios")) || [];
let historico = JSON.parse(localStorage.getItem("historico")) || [];
let tentativas = JSON.parse(localStorage.getItem("tentativas")) || 0;
let bloqueado = localStorage.getItem("bloqueado") || false;

let produtos = [
{nome:"Brinquedo Anti-Ansiedade",preco:39.90,img:"https://images.unsplash.com/photo-1601758124510-52d02ddb7cbd"},
{nome:"Cama Ultra Conforto",preco:129.90,img:"https://images.unsplash.com/photo-1583337130417-3346a1be7dee"},
{nome:"Coleira Premium",preco:49.90,img:"https://images.unsplash.com/photo-1583511655826-05700442b31b"}
];

if(bloqueado){
alert("Conta temporariamente bloqueada por atividade suspeita.");
}

// ===================
// ANTIFRAUDE
// ===================

function verificarFraude(){
tentativas++;
localStorage.setItem("tentativas",tentativas);

if(tentativas > 5){
localStorage.setItem("bloqueado",true);
alert("Muitas tentativas suspeitas. Conta bloqueada.");
}
}

// ===================
// FINALIZAR COMPRA
// ===================

function finalizar(){

if(bloqueado){
alert("Conta bloqueada.");
return;
}

if(carrinho.length == 0){
alert("Carrinho vazio");
verificarFraude();
return;
}

let total = 0;
let resumo = "";
carrinho.forEach(i=>{
total+=i.preco;
resumo+=i.nome+" R$ "+i.preco.toFixed(2)+"\n";
});

// salvar no hist칩rico
let compra = {
data: new Date().toLocaleString(),
itens: carrinho,
total: total.toFixed(2)
};

historico.push(compra);
localStorage.setItem("historico",JSON.stringify(historico));

// limpar carrinho
carrinho = [];
localStorage.setItem("carrinho",JSON.stringify(carrinho));
atualizarCarrinho();

// disparo autom치tico p칩s-compra
setTimeout(()=>{
window.open("https://wa.me/5511912552105?text=Obrigado pela compra! Seu pedido est치 sendo preparado.");
},2000);

window.open("https://wa.me/5511912552105?text=Pedido confirmado:%0A"+resumo+"%0ATotal: R$ "+total.toFixed(2));
}

// ===================
// HIST칍RICO
// ===================

function mostrarHistorico(){
let area = document.getElementById("historicoArea");
area.innerHTML = "<h3>Hist칩rico de Compras</h3>";

historico.forEach(c=>{
area.innerHTML+=`
<div style="background:#ffe8dc;padding:10px;margin-bottom:10px;border-radius:10px">
<strong>${c.data}</strong><br>
Total: R$ ${c.total}
</div>
`;
});
}

// ===================
// REMARKETING
// ===================

window.addEventListener("beforeunload", function (e) {
if(carrinho.length > 0){
localStorage.setItem("remarketing",true);
}
});

if(localStorage.getItem("remarketing")){
setTimeout(()=>{
if(carrinho.length > 0){
alert("游댠 ESPERE! Seu desconto ainda est치 ativo! Finalize agora antes que expire!");
}
},4000);
}

// ===================
// CARRINHO
// ===================

function atualizarCarrinho(){
let lista=document.getElementById("lista");
lista.innerHTML="";
let total=0;

carrinho.forEach((item,i)=>{
total+=item.preco;
lista.innerHTML+=`<li>${item.nome} R$ ${item.preco.toFixed(2)}
<button onclick="removerItem(${i})">X</button></li>`;
});

document.getElementById("total").innerText=total.toFixed(2);
}

function removerItem(i){
carrinho.splice(i,1);
localStorage.setItem("carrinho",JSON.stringify(carrinho));
atualizarCarrinho();
}

atualizarCarrinho();
mostrarHistorico();

</script>
